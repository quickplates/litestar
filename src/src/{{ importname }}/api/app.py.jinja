from collections.abc import Callable, Sequence
from contextlib import AbstractAsyncContextManager
from importlib import metadata

from litestar import Litestar, Router
from litestar.channels import ChannelsPlugin
from litestar.channels.backends.memory import MemoryChannelsBackend
from litestar.openapi import OpenAPIConfig
from litestar.openapi.plugins import ScalarRenderPlugin
from litestar.plugins import PluginProtocol
from litestar.plugins.pydantic import PydanticPlugin

from {{ importname }}.api.routes.router import router
from {{ importname }}.config.models import Config
from {{ importname }}.state import State


class AppBuilder:
    """Builds the app.

    Args:
        config: Config object.

    """

    def __init__(self, config: Config) -> None:
        self._config = config

    def _get_route_handlers(self) -> Sequence[Router]:
        return [router]

    def _get_debug(self) -> bool:
        return self._config.debug

    def _build_lifespan(
        self,
    ) -> Sequence[Callable[[Litestar], AbstractAsyncContextManager]]:
        return []

    def _build_openapi_config(self) -> OpenAPIConfig:
        return OpenAPIConfig(
            title="{{ servicename }}",
            version=metadata.version("{{ importname }}"),
            description="{{ description }}",
            use_handler_docstrings=True,
            path="/openapi",
            render_plugins=[
                ScalarRenderPlugin(
                    path="/openapi",
                    options={
                        "hideClientButton": True,
                    },
                ),
            ],
        )

    def _build_channels_plugin(self) -> ChannelsPlugin:
        return ChannelsPlugin(
            # Store events in memory (good only for single instance services)
            backend=MemoryChannelsBackend(),
            # Channels to handle
            channels=["events"],
            # Don't allow channels outside of the list above
            arbitrary_channels_allowed=False,
        )

    def _build_pydantic_plugin(self) -> PydanticPlugin:
        return PydanticPlugin(
            # Use aliases for serialization
            prefer_alias=True,
            # Allow type coercion
            validate_strict=False,
        )

    def _build_plugins(self) -> Sequence[PluginProtocol]:
        return [
            self._build_channels_plugin(),
            self._build_pydantic_plugin(),
        ]

    def _build_initial_state(self) -> State:
        config = self._config

        return State(
            {
                "config": config,
            }
        )

    def build(self) -> Litestar:
        """Build the app."""
        return Litestar(
            route_handlers=self._get_route_handlers(),
            debug=self._get_debug(),
            lifespan=self._build_lifespan(),
            openapi_config=self._build_openapi_config(),
            plugins=self._build_plugins(),
            state=self._build_initial_state(),
        )
